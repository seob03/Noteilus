# 백엔드 스테이지
FROM node:22-bookworm
WORKDIR /app

# Poppler 유틸리티, GraphicsMagick, Ghostscript, Python 설치 및 venv 구성
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    poppler-utils graphicsmagick ghostscript python3 python3-venv python3-pip build-essential \
 && python3 -m venv /opt/venv \
 && /opt/venv/bin/pip install --no-cache-dir --upgrade pip \
 && /opt/venv/bin/pip install --no-cache-dir pymupdf \
 && rm -rf /var/lib/apt/lists/*

# venv 경로를 기본 PATH에 추가
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

COPY be/package*.json .
RUN npm install

ENV NODE_ENV=production

COPY be/ .

EXPOSE 8080

USER node
CMD ["node", "server.js"]